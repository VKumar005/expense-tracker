<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-dark">Expense Manager</h2>
        
        <form action="/" method="GET" class="d-flex gap-2 align-items-center">
            <label class="fw-bold">View Date:</label>
            <input type="date" name="date" class="form-control" value="{{ selected_date }}" required>
            <button type="submit" class="btn btn-primary">Go</button>
            <a href="/" class="btn btn-outline-secondary">Reset</a>
        </form>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3 shadow-sm">
                <div class="card-header">Spend on {{ selected_date }}</div>
                <div class="card-body"><h3 class="card-title">₹{{ daily }}</h3></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3 shadow-sm">
                <div class="card-header">Month Total</div>
                <div class="card-body"><h3 class="card-title">₹{{ monthly }}</h3></div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning mb-3 shadow-sm">
                <div class="card-header">Year Total</div>
                <div class="card-body"><h3 class="card-title">₹{{ yearly }}</h3></div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-5">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white">Add New Expense</div>
                <div class="card-body">
                    <form action="/add" method="POST">
                        <div class="mb-3">
                            <label>Date</label>
                            <input type="date" name="date" class="form-control" value="{{ selected_date }}" required>
                        </div>
                        <div class="mb-3">
                            <label>Category</label>
                            <select name="category" class="form-select">
                                <option value="Food">Food</option>
                                <option value="Travel">Travel</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Bills">Bills</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Description</label>
                            <input type="text" name="description" placeholder="Description" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label>Amount (₹)</label>
                            <input type="number" step="0.01" name="amount" placeholder="0.00" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Add Expense</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span id="chartTitle">Daily Breakdown</span>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-light active" onclick="updateDashboard('daily', this)">Day</button>
                        <button type="button" class="btn btn-outline-light" onclick="updateDashboard('monthly', this)">Month</button>
                        <button type="button" class="btn btn-outline-light" onclick="updateDashboard('yearly', this)">Year</button>
                    </div>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <div style="height: 300px; width: 100%;">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h4 class="mb-3">History <span id="tableLabel" class="text-muted fs-6">(Showing Daily)</span></h4>
    <table class="table table-striped table-hover bg-white rounded shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Action</th>
            </tr>
        </thead>
        <tbody id="historyTableBody">
            {% for row in expenses %}
            <tr data-date="{{ row[1] }}" class="{% if row[1] == selected_date %}table-info border border-primary{% endif %}">
                <td>{{ row[1] }}</td>
                <td><span class="badge bg-secondary">{{ row[2] }}</span></td>
                <td>{{ row[3] }}</td>
                <td class="fw-bold">₹{{ row[4] }}</td>
                <td><a href="/delete/{{ row[0] }}" class="btn btn-danger btn-sm">Delete</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    const dailyData = { labels: {{ daily_labels | tojson }}, values: {{ daily_values | tojson }} };
    const monthlyData = { labels: {{ monthly_labels | tojson }}, values: {{ monthly_values | tojson }} };
    const yearlyData = { labels: {{ yearly_labels | tojson }}, values: {{ yearly_values | tojson }} };

    const selectedDate = "{{ selected_date }}";
    const selectedMonth = selectedDate.substring(0, 7);
    const selectedYear = selectedDate.substring(0, 4);

    const ctx = document.getElementById('expenseChart');
    let currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: dailyData.labels,
            datasets: [{
                label: 'Expenses',
                data: dailyData.values,
                backgroundColor: ['#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0', '#9966ff', '#ff9f40'],
                hoverOffset: 4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    function updateDashboard(period, btnElement) {
        let newData;
        let filterType;
        let titleText;

        if (period === 'daily') {
            newData = dailyData;
            filterType = 'day';
            titleText = "(Showing Daily)";
            document.getElementById('chartTitle').innerText = "Daily Breakdown";
        } else if (period === 'monthly') {
            newData = monthlyData;
            filterType = 'month';
            titleText = "(Showing Monthly)";
            document.getElementById('chartTitle').innerText = "Monthly Breakdown";
        } else if (period === 'yearly') {
            newData = yearlyData;
            filterType = 'year';
            titleText = "(Showing Yearly)";
            document.getElementById('chartTitle').innerText = "Yearly Breakdown";
        }

        // Update Chart
        currentChart.data.labels = newData.labels;
        currentChart.data.datasets[0].data = newData.values;
        currentChart.update();

        // Update Table
        const rows = document.querySelectorAll('#historyTableBody tr');
        rows.forEach(row => {
            const rowDate = row.getAttribute('data-date');
            let showRow = false;

            if (filterType === 'day') {
                if (rowDate === selectedDate) showRow = true;
            } else if (filterType === 'month') {
                if (rowDate.startsWith(selectedMonth)) showRow = true;
            } else if (filterType === 'year') {
                if (rowDate.startsWith(selectedYear)) showRow = true;
            }

            row.style.display = showRow ? '' : 'none';
        });

        document.getElementById('tableLabel').innerText = titleText;

        if (btnElement) {
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
        }
    }

    // Auto-load Filter on Start
    window.onload = function() {
        const dailyBtn = document.querySelector('.btn-group .btn');
        updateDashboard('daily', dailyBtn);
    };
</script>

</body>
</html>